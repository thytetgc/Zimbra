#!/bin/bash

# Verifica se está sendo executado como root
if [ "$(id -u)" -ne 0 ]; then
    echo "Este script deve ser executado como root."
    exit 1
fi

# Verifica se o usuário zimbra existe
if ! id -u zimbra >/dev/null 2>&1; then
    echo "Usuário zimbra não encontrado."
    exit 1
fi

# Obtém todos os domínios em ordem alfabética
echo "Obtendo lista de domínios..."
DOMINIOS=$(su - zimbra -c "zmprov gad" | sort)

# Para cada domínio, obtém todos os usuários em ordem alfabética
for DOMINIO in $DOMINIOS; do
    echo -e "\nProcessando domínio: $DOMINIO"
    
    # Obtém todos os usuários do domínio em ordem alfabética
    USUARIOS=$(su - zimbra -c "zmprov -l gaa $DOMINIO" | sort)
    
    for USUARIO in $USUARIOS; do
        # Combina todas as modificações em um único comando zmprov
        COMANDO="ma $USUARIO zimbraPrefClientType '' zimbraPrefSkin '' zimbraAvailableSkin '' zimbraFeatureAllowUsernameInPassword '' zimbraPrefGroupMailBy ''"
        
        # Executa o comando combinado
        su - zimbra -c "zmprov $COMANDO" >/dev/null 2>&1
        
        # Verifica se o comando foi executado com sucesso
        if [ $? -eq 0 ]; then
            echo "Usuário processado: $USUARIO"
        else
            echo "Erro ao atualizar usuário: $USUARIO"
        fi
    done
    echo "Domínio concluído: $DOMINIO"
done

echo -e "\nProcesso concluído para todos os domínios."
